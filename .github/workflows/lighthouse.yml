name: Lighthouse CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build production bundle
        run: npm run build
        env:
          CI: true
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.14.x

      - name: Run Lighthouse CI
        run: lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 30

      - name: Parse Lighthouse results
        id: lighthouse-results
        if: always()
        run: |
          if [ -f .lighthouseci/manifest.json ]; then
            PERFORMANCE=$(cat .lighthouseci/manifest.json | jq -r '.[0].summary.performance * 100 | floor')
            ACCESSIBILITY=$(cat .lighthouseci/manifest.json | jq -r '.[0].summary.accessibility * 100 | floor')
            BEST_PRACTICES=$(cat .lighthouseci/manifest.json | jq -r '.[0].summary["best-practices"] * 100 | floor')
            SEO=$(cat .lighthouseci/manifest.json | jq -r '.[0].summary.seo * 100 | floor')
            
            echo "performance=$PERFORMANCE" >> $GITHUB_OUTPUT
            echo "accessibility=$ACCESSIBILITY" >> $GITHUB_OUTPUT
            echo "best_practices=$BEST_PRACTICES" >> $GITHUB_OUTPUT
            echo "seo=$SEO" >> $GITHUB_OUTPUT
          else
            echo "No Lighthouse results found"
            echo "performance=0" >> $GITHUB_OUTPUT
            echo "accessibility=0" >> $GITHUB_OUTPUT
            echo "best_practices=0" >> $GITHUB_OUTPUT
            echo "seo=0" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const performance = '${{ steps.lighthouse-results.outputs.performance }}';
            const accessibility = '${{ steps.lighthouse-results.outputs.accessibility }}';
            const bestPractices = '${{ steps.lighthouse-results.outputs.best_practices }}';
            const seo = '${{ steps.lighthouse-results.outputs.seo }}';
            
            const getEmoji = (score) => {
              if (score >= 90) return 'âœ…';
              if (score >= 70) return 'âš ï¸';
              return 'âŒ';
            };
            
            const comment = `## ğŸ”¦ Lighthouse CI Results
            
| Category | Score | Status |
|----------|-------|--------|
| **Performance** | ${performance}/100 | ${getEmoji(performance)} |
| **Accessibility** | ${accessibility}/100 | ${getEmoji(accessibility)} |
| **Best Practices** | ${bestPractices}/100 | ${getEmoji(bestPractices)} |
| **SEO** | ${seo}/100 | ${getEmoji(seo)} |

**Budget Thresholds:**
- âœ… Performance: 85+
- âœ… Accessibility: 90+
- âœ… Best Practices: 90+
- âœ… SEO: 90+

[View Detailed Report â†’](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

