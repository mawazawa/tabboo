name: Claude Automated Development Pipeline

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read

on:
  # Auto-review and fix on every PR
  pull_request:
    types: [opened, synchronize, ready_for_review]

  # Manual trigger with @claude still available
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  # Job 1: Automatic PR review and fix (no @claude needed)
  auto-review-and-fix:
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.labels.*.name, 'skip-claude')
    runs-on: ubuntu-latest
    outputs:
      linear_issue_id: ${{ steps.linear.outputs.issue_id }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Linear Issue for Tracking
        id: linear
        run: |
          RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: ${{ secrets.LINEAR_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url } } }",
              "variables": {
                "input": {
                  "teamId": "${{ secrets.LINEAR_TEAM_ID }}",
                  "title": "PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}",
                  "description": "Automated tracking for PR: ${{ github.event.pull_request.html_url }}\n\nBranch: ${{ github.event.pull_request.head.ref }}\nAuthor: ${{ github.event.pull_request.user.login }}",
                  "labelIds": ["${{ secrets.LINEAR_AUTOMATION_LABEL_ID }}"],
                  "stateId": "e63e2885-a4dc-419c-a795-4d3ccafbbea6"
                }
              }
            }')
          ISSUE_ID=$(echo $RESPONSE | jq -r '.data.issueCreate.issue.identifier')
          echo "issue_id=$ISSUE_ID" >> $GITHUB_OUTPUT
          echo "✅ Created Linear issue: $ISSUE_ID"

      - name: Claude Auto-Review and Fix
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          timeout_minutes: "60"
          max_turns: "100"

          # Fully autonomous prompt - review, fix, push
          direct_prompt: |
            You are an autonomous code reviewer. Your job is to get this PR to production.

            ## Your Tasks (do ALL of these):

            1. **Review the PR changes** - Understand what was changed
            2. **Run the build**: `npm run build`
            3. **Run tests**: `npm run test`
            4. **Run type check**: `npm run typecheck` or `npx tsc --noEmit`
            5. **Run lint**: `npm run lint`

            ## If ANY check fails:
            - Fix the issues immediately
            - Commit the fixes with message: "fix: [description of fix]"
            - Push to the PR branch
            - Re-run the checks to verify

            ## Continue until:
            - All checks pass (build, test, typecheck, lint)
            - OR you've made 5 fix attempts

            ## Important:
            - Make minimal, targeted fixes
            - Don't refactor unrelated code
            - Commit each logical fix separately
            - Always push after fixing

            ## Store learnings:
            Use the memory MCP to store any patterns or issues you find for future reference.
            Use Neo4j to store relationships between files, components, and issues.

            Start now. Get this PR ready for production.

          # MCP Configuration
          mcp_config: |
            {
              "mcpServers": {
                "neo4j": {
                  "command": "npx",
                  "args": ["-y", "@neo4j-labs/mcp-neo4j"],
                  "env": {
                    "NEO4J_URI": "${{ secrets.NEO4J_URI }}",
                    "NEO4J_USERNAME": "${{ secrets.NEO4J_USERNAME }}",
                    "NEO4J_PASSWORD": "${{ secrets.NEO4J_PASSWORD }}",
                    "NEO4J_DATABASE": "neo4j"
                  }
                },
                "exa": {
                  "command": "npx",
                  "args": ["-y", "exa-mcp-server"],
                  "env": {
                    "EXA_API_KEY": "${{ secrets.EXA_API_KEY }}"
                  }
                },
                "supabase": {
                  "command": "npx",
                  "args": ["-y", "@supabase/mcp-server-supabase@latest"],
                  "env": {
                    "SUPABASE_ACCESS_TOKEN": "${{ secrets.SUPABASE_ACCESS_TOKEN }}"
                  }
                },
                "memory": {
                  "command": "npx",
                  "args": ["-y", "@modelcontextprotocol/server-memory"]
                }
              }
            }

          allowed_tools: |
            Bash(git:*),Bash(npm:*),Bash(npx:*),Bash(node:*),
            View,GlobTool,GrepTool,BatchTool,
            Edit,Write,Read,
            mcp__neo4j__*,
            mcp__exa__*,
            mcp__supabase__*,
            mcp__memory__*

  # Job 2: Manual @claude trigger (still available)
  manual-claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: "@claude"
          timeout_minutes: "60"
          max_turns: "50"

          mcp_config: |
            {
              "mcpServers": {
                "neo4j": {
                  "command": "npx",
                  "args": ["-y", "@neo4j-labs/mcp-neo4j"],
                  "env": {
                    "NEO4J_URI": "${{ secrets.NEO4J_URI }}",
                    "NEO4J_USERNAME": "${{ secrets.NEO4J_USERNAME }}",
                    "NEO4J_PASSWORD": "${{ secrets.NEO4J_PASSWORD }}",
                    "NEO4J_DATABASE": "neo4j"
                  }
                },
                "exa": {
                  "command": "npx",
                  "args": ["-y", "exa-mcp-server"],
                  "env": {
                    "EXA_API_KEY": "${{ secrets.EXA_API_KEY }}"
                  }
                },
                "memory": {
                  "command": "npx",
                  "args": ["-y", "@modelcontextprotocol/server-memory"]
                }
              }
            }

          allowed_tools: |
            Bash(git:*),Bash(npm:*),Bash(npx:*),
            View,GlobTool,GrepTool,BatchTool,
            Edit,Write,Read,
            mcp__neo4j__*,
            mcp__exa__*,
            mcp__memory__*

  # Job 3: Auto-merge when all checks pass
  auto-merge:
    needs: auto-review-and-fix
    if: |
      github.event_name == 'pull_request' &&
      needs.auto-review-and-fix.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for all checks
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
          allowed-conclusions: success

      - name: Enable auto-merge
        run: |
          gh pr merge ${{ github.event.pull_request.number }} \
            --auto \
            --squash \
            --delete-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Linear to Production
        run: |
          curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: ${{ secrets.LINEAR_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation UpdateIssue($id: String!, $input: IssueUpdateInput!) { issueUpdate(id: $id, input: $input) { success } }",
              "variables": {
                "id": "${{ needs.auto-review-and-fix.outputs.linear_issue_id }}",
                "input": {
                  "stateId": "${{ secrets.LINEAR_DONE_STATE_ID }}"
                }
              }
            }'
          echo "✅ Linear issue updated to Done"

      - name: Store in Neo4j Knowledge Graph
        run: |
          npx -y @neo4j-labs/mcp-neo4j << 'EOF'
          MERGE (pr:PullRequest {number: ${{ github.event.pull_request.number }}})
          SET pr.title = "${{ github.event.pull_request.title }}",
              pr.author = "${{ github.event.pull_request.user.login }}",
              pr.merged_at = datetime(),
              pr.branch = "${{ github.event.pull_request.head.ref }}",
              pr.linear_issue = "${{ needs.auto-review-and-fix.outputs.linear_issue_id }}",
              pr.files_changed = ${{ github.event.pull_request.changed_files }},
              pr.additions = ${{ github.event.pull_request.additions }},
              pr.deletions = ${{ github.event.pull_request.deletions }}
          EOF
        env:
          NEO4J_URI: ${{ secrets.NEO4J_URI }}
          NEO4J_USERNAME: ${{ secrets.NEO4J_USERNAME }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
